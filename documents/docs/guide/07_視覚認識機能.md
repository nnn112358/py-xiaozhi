# 视觉识别功能

## 功能概述

py-xiaozhi提供了摄像头控制和视觉识别功能，支持通过语音命令打开/关闭摄像头，以及对摄像头捕获的画面进行智能识别分析。

## 配置说明

视觉识别功能需要在配置文件中进行相关设置：

```json
"CAMERA": { 
  "camera_index": 0,         // カメラインデックス、0は通常コンピューター内蔵カメラ
  "frame_width": 640,        // 映像幅
  "frame_height": 480,       // 映像高さ
  "fps": 30,                 // フレームレート
  "Loacl_VL_url": "https://open.bigmodel.cn/api/paas/v4/", // 智譜 API アドレス
  "VLapi_key": "あなたのkey",     // 智譜視覚大モデル API キー
  "models": "glm-4v-plus"    // 使用する視覚モデル
}
```

## 智譜視覚大モデル設定

1. [智譜 AI オープンプラットフォーム](https://open.bigmodel.cn/) にアクセス
2. アカウントを登録し、API キーを作成
3. 取得した API キーを `config.json` の `CAMERA.VLapi_key` フィールドに設定
4. 使用するモデルを選択できます。デフォルトは `glm-4v-plus` です

## 使用方法

### 音声コマンド制御

システムは以下の音声コマンドでカメラと視覚認識機能を制御できます：

- **カメラをオンにする**：システムカメラをアクティベートし、ビデオストリームのキャプチャを開始
- **カメラをオフにする**：カメラのキャプチャを停止
- **映像を認識する**：現在のカメラ映像にインテリジェント視覚分析を実行し、映像内のコンテンツを認識
- **画像を分析する**：現在の映像に詳細な視覚分析を実行し、説明を提供
- **何が見える？**：現在のカメラが見ている内容を照会

### GUI インターフェース制御

グラフィカルインターフェースモードでは、インターフェース上の関連ボタンでカメラ機能を制御できます。

## 内部実装

視覚認識機能は IoT モジュール内の CameraVL デバイスクラスで実装され、主に Camera と VL の2つのコンポーネントで構成されています：

1. **Camera コンポーネント**：カメラの基本制御を担当。オン/オフ、ビデオフレーム取得など
2. **VL（Vision Language）コンポーネント**：画像のインテリジェント分析を担当。智譜視覚大モデル API を呼び出し

実装構造：

```
CameraVL                 # カメラと視覚認識統合デバイス
├── Camera.py            # カメラ制御モジュール
└── VL.py                # 視覚言語分析モジュール
```

## 工作流程

1. 用户通过语音命令打开摄像头
2. 系统激活摄像头并在界面显示视频流
3. 用户请求识别当前画面
4. 系统截取当前帧，并将图像发送给智普视觉大模型
5. 获取视觉分析结果并通过语音或文字反馈给用户

## 隐私说明

视觉识别功能会使用您的摄像头并处理画面内容，请注意：

1. 摄像头捕获的画面仅用于本地分析或发送至智普API进行分析
2. 非语音命令控制时，摄像头处于关闭状态
3. 可以在配置中修改摄像头设置或完全禁用此功能

## 常见问题

1. **摄像头无法打开**
   - 确认您的设备有可用摄像头
   - 检查摄像头是否被其他应用占用
   - 确认已授予应用使用摄像头的权限

2. **视觉识别功能无响应**
   - 检查智普API密钥是否正确配置
   - 确认网络连接正常
   - 检查是否超出API调用次数限制

3. **识别结果不准确**
   - 尝试改善摄像头光线条件
   - 确保目标对象在画面中清晰可见
   - 可能需要升级智普视觉模型版本

4. **摄像头画面卡顿**
   - 尝试在配置中降低分辨率或帧率
   - 关闭其他占用系统资源的应用
   - 更新摄像头驱动 